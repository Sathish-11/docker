pipeline {
    agent { label 'slave01' }

    environment {
        DOCKER_HUB_IMAGE = "sathish1102/newimg-py1"
        TEST_SERVER = "192.168.112.130"  // <-- updated here
        DEPLOY_DIR = "/home/devopsadmin/app-deploy-dir"
        GIT_REPO = "https://github.com/Sathish-11/docker.git"
    }

    stages {

        stage('SCM Checkout') {
            steps {
                git branch: 'main', credentialsId: '9608b82a-1646-4511-a57f-67e89e948cc0', url: "${GIT_REPO}"
            }
        }

        stage('Build and Push Docker Image') {
            steps {
                sh 'docker build -t $DOCKER_HUB_IMAGE .'
                withCredentials([usernamePassword(credentialsId: 'docker-login', passwordVariable: 'DOCKER_PASSWORD', usernameVariable: 'DOCKER_USERNAME')]) {
                    sh '''
                        echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
                        docker push $DOCKER_HUB_IMAGE
                    '''
                }
            }
        }

        stage('Deploy to Test Server using Docker Compose') {
            steps {
                script {
                    sshagent(['Test-Server']) {
                        sh """
                        ssh -o StrictHostKeyChecking=no devopsadmin@$TEST_SERVER '
                          set -e

                          # Instead of removing the whole directory, just update code (safer for docker-compose file)
                          if [ ! -d "$DEPLOY_DIR" ]; then
                              git clone $GIT_REPO $DEPLOY_DIR
                          else
                            cd $DEPLOY_DIR
                            git fetch --all
                            git reset --hard origin/main
                          fi

                          cd $DEPLOY_DIR

                          # Clean up old containers and orphan networks
                          docker-compose down --remove-orphans || true
                          docker network prune -f || true

                          # Pull latest images (important if using images instead of building)
                          docker-compose pull

                          # Start containers (build only if you have local Dockerfiles)
                          docker-compose up -d --build

                          # Optional: prune unused docker images
                          docker image prune -af || true
                        '

                        """
                    }
                }
            }
        }
    }

    post {
        failure {
            echo "❌ Deployment failed. Check logs above for details."
        }
        success {
            echo "✅ Deployment to $TEST_SERVER completed successfully."
        }
    }
}
